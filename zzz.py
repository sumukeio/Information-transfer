import pandas as pd
from openpyxl import load_workbook
import os

# ================= é…ç½®åŒºåŸŸ =================
# 1. æ–‡ä»¶åé…ç½®
template_path = 'SOP_Template.xlsx'  # æ¨¡æ¿æ–‡ä»¶
data_path = 'ç”Ÿäº§å‚æ•°è®°å½•è¡¨.csv'       # æ•°æ®æºæ–‡ä»¶
output_folder = './SOP_Output/'               # ç»“æœè¾“å‡ºä½ç½®

if not os.path.exists(output_folder):
    os.makedirs(output_folder)

# 2. è¯»å–æ•°æ® (è·³è¿‡å‰3è¡Œæ— ç”¨è¡¨å¤´ï¼Œå‡è®¾ç¬¬4è¡Œæ˜¯åˆ—å)
# å¦‚æœä½ çš„CSVç¬¬ä¸€è¡Œå°±æ˜¯åˆ—åï¼Œè¯·å»æ‰ skiprows=3
# df = pd.read_csv(data_path, encoding='utf-8')

# å°è¯• utf-8ï¼Œå¦‚æœæŠ¥é”™ UnicodeDecodeError å†æ”¹æˆ gbk
try:
    df = pd.read_csv(data_path, encoding='utf-8')
except UnicodeDecodeError:
    df = pd.read_csv(data_path, encoding='gbk')


# å»ºè®®åŠ ä¸€è¡Œæ‰“å°ï¼Œç¡®è®¤åˆ—åè¯»å¯¹æ²¡
# print("å½“å‰è¯»å–åˆ°çš„åˆ—åç¤ºä¾‹ï¼š", df.columns[:5])
print(f"æˆåŠŸè¯»å–æ•°æ®ï¼Œå…± {len(df)} è¡Œã€‚")


# æ£€æŸ¥ä¸€ä¸‹åˆ—åæ˜¯å¦åŒ…å«æˆ‘ä»¬éœ€è¦çš„å­—æ®µ
if 'é”æ¨¡_é”æ¨¡ä¸€æ®µ_å‹åŠ›' not in df.columns:
    print("âŒ è­¦å‘Šï¼šæœªæ‰¾åˆ°é¢„æœŸåˆ—åï¼è¯·æ£€æŸ¥CSVæ–‡ä»¶æ˜¯å¦ä¸ºä¿®å¤åçš„ç‰ˆæœ¬ã€‚")
    print("å®é™…åˆ—åï¼š", df.columns.tolist()[:5])
    exit()


# ================= æ ¸å¿ƒé€»è¾‘ =================
def generate_sop(row):
    


     # æ•°å€¼è½¬å­—ç¬¦ä¸²ï¼Œé¿å… None æŠ¥é”™
    def get_val(key, default=None):
        # å°è¯•è·å–å€¼
        val = row.get(key)
        # åˆ¤æ–­ï¼šå¦‚æœæ˜¯ NaN (ç©ºå€¼)ã€Noneã€æˆ–è€…çº¯ç©ºæ ¼ï¼Œéƒ½è§†ä¸ºç©ºå­—ç¬¦ä¸²
        if pd.isna(val) or str(val).lower() == 'nan' or str(val).strip() == '':
            return ""
        
        # è½¬æˆå­—ç¬¦ä¸²å¹¶å»é™¤é¦–å°¾ç©ºæ ¼
        s_val = str(val).strip()
        
        # å»æ‰ Excel å¯¼å…¥æ—¶å¯èƒ½å‡ºç°çš„ .0 (æ¯”å¦‚ "25.0" -> "25")
        if s_val.endswith('.0'):
            return s_val[:-2]
            
        return s_val

    # # --- 1. å®šä¹‰ä¸€ä¸ªâ€œæ¸…æ´—å–å€¼â€çš„è¾…åŠ©å‡½æ•° (æ”¾åœ¨ mapping ä¹‹å‰) ---
    # def get_val(key):
    #     val = get_val(key)
    #     # åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœæ˜¯ NaNã€None æˆ–è€…çº¯ç©ºæ ¼ï¼Œéƒ½è§†ä¸ºç©º
    #     if pd.isna(val) or str(val).lower() == 'nan' or str(val).strip() == '':
    #         return ""
    #     # é¡ºæ‰‹æŠŠ '.0' å»æ‰ï¼ˆæ¯”å¦‚ '25.0' å˜æˆ '25'ï¼ŒSOPé‡Œæ›´å¥½çœ‹ï¼‰
    #     s_val = str(val).strip()
    #     if s_val.endswith('.0'):
    #         return s_val[:-2]
    #     return s_val


    # è·³è¿‡ç©ºè¡Œï¼ˆæœ‰äº›CSVæœ«å°¾ä¼šæœ‰ç©ºè¡Œï¼‰
    if pd.isna(get_val('æ¨¡å…·ç¼–å·')):
        return


    wb = load_workbook(template_path)
    ws = wb.active

    # --- 1. æ•°æ®æ¸…æ´—ä¸æ‹¼æ¥é€»è¾‘ ---
    
    # -----åŸºç¡€å­—æ®µ-----
    mold_id = str(get_val('æ¨¡å…·ç¼–å·', '')).strip()
    prod_name = str(get_val('äº§å“åç§°', '')).strip()
    
    # é€»è¾‘ï¼šæ¨¡å…·ç¼–å· + äº§å“åç§°
    full_prod_name = f"{mold_id}{prod_name}"
    
    # é€»è¾‘ï¼šæ¨¡å…·ç©´æ•° (* è½¬ å‡º)
    cavity = str(get_val('æ¨¡å…·ç©´æ•°', '')).replace('*', 'å‡º')
    

   

    # -----ç‰¹æ®Šé€»è¾‘å¤„ç†-----    

    # å…‹é‡åŠ å•ä½ g (å¦‚æœæ˜¯ç©ºå€¼å°±ä¸åŠ )
    std_wt = f"{get_val('æ ‡å‡†å•é‡/g')}g" if pd.notna(get_val('æ ‡å‡†å•é‡/g')) else ""
    act_wt = f"{get_val('å®é™…å•é‡/g')}g" if pd.notna(get_val('å®é™…å•é‡/g')) else ""
    
    # æœºå°ç¼–å·å¤„ç†
    mach_id = str(get_val('æœºå°ç¼–å·', '')).replace('.0', '') # å»æ‰å¯èƒ½çš„å°æ•°ç‚¹
    mach_model = f"{mach_id}T  {mach_id}"
    
    # æˆå‹å‘¨æœŸæ‹¼æ¥
    cycle_val = str(get_val('æˆå‹å‘¨æœŸ/s', '')).replace('nan', '').strip()
    cycle_str = f"æˆå‹å‘¨æœŸï¼š {cycle_val}  ç§’"
    
    # å¹æ°”æ‹¼æ¥
    # å•ç‹¬å–å‡ºå€¼ï¼Œå¤„ç†ä¸€ä¸‹ç©ºå€¼ï¼Œç„¶åå†æ‹¼å­—ç¬¦ä¸²
    blow_m = get_val('é¡¶é’ˆ_å¹æ°”_å…¬æ¨¡/s', '')
    blow_f = get_val('é¡¶é’ˆ_å¹æ°”_æ¯æ¨¡/s', '')
    blow_p = get_val('é¡¶é’ˆ_å¹æ°”_ä½ç½®/mm', '')
    # åªæœ‰å½“è¿™ä¸‰ä¸ªå€¼è‡³å°‘æœ‰ä¸€ä¸ªå­˜åœ¨æ—¶ï¼Œæ‰æ˜¾ç¤ºæ–‡æœ¬ï¼Œæˆ–è€…ä½ æ— è®ºå¦‚ä½•éƒ½æƒ³æ˜¾ç¤ºæ¨¡æ¿æ–‡å­—ä¹Ÿå¯ä»¥
    # è¿™é‡Œä¿æŒä½ è¦æ±‚çš„æ ¼å¼ï¼Œç©ºå€¼åªæ˜¾ç¤ºç©ºç™½
    blow_text = f"å…¬æ¨¡ï¼š{blow_m} ç§’   æ¯æ¨¡ï¼š{blow_f} ç§’   ä½ç½®ï¼š {blow_p} mm"


    # é¡¶é’ˆæ¬¡æ•°
    eject_count = get_val('é¡¶é’ˆ_é¡¶å‡ºæ–¹å¼_é¡¶é’ˆæ¬¡æ•°')
    eject_text = f"é¡¶é’ˆæ¬¡æ•°ï¼š{eject_count}"

    # èƒŒå‹
    bp_val = get_val('èƒŒå‹')
    bp_str = f"{bp_val}s" if bp_val else ""

    # ã€ä¿®æ”¹ç‚¹2ï¼šç†”èƒ¶å†·å´ã€‘åŒç†
    cool_val = get_val('ç†”èƒ¶_å†·å´')
    cool_str = f"{cool_val}s" if cool_val else ""






    # --- 2. åæ ‡æ˜ å°„ (å·²æ ¹æ®ä½ çš„æ–‡ä»¶å¸®ä½ é¢„å¡«äº†è¡¨å¤´) ---
    mapping = {
        # === è¡¨å¤´åŸºæœ¬ä¿¡æ¯ (æˆ‘å·²å¸®ä½ åˆ†æç¡®è®¤) ===
        'E5': mold_id,          # äº§å“å‹å·(æ¨¡å…·ç¼–å·)
        'L5': full_prod_name,   # äº§å“åç§°/ç¼–å· (åŸä½ç½®H5æ˜¯æ ‡ç­¾ï¼Œæ¨æµ‹å€¼åœ¨K5)
        'U5': mold_id,          # æ¨¡å…·å‹å·
        'AB5': cavity,          # æ¨¡å…·ç©´æ•°
        'AD5': get_val('é¢œè‰²', ''), # é¢œè‰²
        'AG5': std_wt,          # æ ‡å‡†å…‹é‡
        'AI5': act_wt,          # å®é™…å…‹é‡
        'AD2': mach_model,      # è®¾å¤‡å‹å·
        
        # === åº•éƒ¨ä¿¡æ¯ ===
        'B40': cycle_str,       # æˆå‹å‘¨æœŸ (å‡è®¾åœ¨C40ï¼Œè¯·ç”¨æå–è„šæœ¬ç¡®è®¤ï¼)

        # === å·¥è‰ºå‚æ•° (éœ€è¦ä½ ç”¨æå–è„šæœ¬ç¡®è®¤åæ ‡ï¼) ===
        # æ ¼å¼ï¼šws['åæ ‡'] = get_val('CSVåˆ—å')
        
        # ç¤ºä¾‹ï¼šé”æ¨¡å‚æ•° (å‡è®¾ E11 æ˜¯ç¬¬ä¸€æ®µå‹åŠ›)
        'E11': get_val('é”æ¨¡_é”æ¨¡ä¸€æ®µ_å‹åŠ›'), 
        'G11': get_val('é”æ¨¡_é”æ¨¡ä¸€æ®µ_é€Ÿåº¦'),
        'I11': get_val('é”æ¨¡_é”æ¨¡ä¸€æ®µ_ä½ç½®'),
        'E12': get_val('é”æ¨¡_é”æ¨¡äºŒæ®µ_å‹åŠ›'), 
        'G12': get_val('é”æ¨¡_é”æ¨¡äºŒæ®µ_é€Ÿåº¦'),
        'I12': get_val('é”æ¨¡_é”æ¨¡äºŒæ®µ_ä½ç½®'),
        'E13': get_val('é”æ¨¡_é”æ¨¡ä¸‰æ®µ_å‹åŠ›'), 
        'G13': get_val('é”æ¨¡_é”æ¨¡ä¸‰æ®µ_é€Ÿåº¦'),
        'I13': get_val('é”æ¨¡_é”æ¨¡ä¸‰æ®µ_ä½ç½®'),
        'E14': get_val('é”æ¨¡_é”æ¨¡ä½å‹_å‹åŠ›'), 
        'G14': get_val('é”æ¨¡_é”æ¨¡ä½å‹_é€Ÿåº¦'),
        'I14': get_val('é”æ¨¡_é”æ¨¡ä½å‹_ä½ç½®'),
        'E15': get_val('é”æ¨¡_é”æ¨¡é«˜å‹_å‹åŠ›'), 
        'G15': get_val('é”æ¨¡_é”æ¨¡é«˜å‹_é€Ÿåº¦'),
        'I15': get_val('é”æ¨¡_é”æ¨¡é«˜å‹_ä½ç½®'),
        'K11': get_val('é”æ¨¡_æ—¶é—´'),
        'E16': get_val('å¼€æ¨¡_å¼€æ¨¡ä¸€æ®µ_å‹åŠ›'), 
        'G16': get_val('å¼€æ¨¡_å¼€æ¨¡ä¸€æ®µ_é€Ÿåº¦'),
        'I16': get_val('å¼€æ¨¡_å¼€æ¨¡ä¸€æ®µ_ä½ç½®'),
        'E17': get_val('å¼€æ¨¡_å¼€æ¨¡äºŒæ®µ_å‹åŠ›'), 
        'G17': get_val('å¼€æ¨¡_å¼€æ¨¡äºŒæ®µ_é€Ÿåº¦'),
        'I17': get_val('å¼€æ¨¡_å¼€æ¨¡äºŒæ®µ_ä½ç½®'),
        'E18': get_val('å¼€æ¨¡_å¼€æ¨¡ä¸‰æ®µ_å‹åŠ›'), 
        'G18': get_val('å¼€æ¨¡_å¼€æ¨¡ä¸‰æ®µ_é€Ÿåº¦'),
        'I18': get_val('å¼€æ¨¡_å¼€æ¨¡ä¸‰æ®µ_ä½ç½®'),
        'E19': get_val('å¼€æ¨¡_å¼€æ¨¡å››æ®µ_å‹åŠ›'), 
        'G19': get_val('å¼€æ¨¡_å¼€æ¨¡å››æ®µ_é€Ÿåº¦'),
        'I19': get_val('å¼€æ¨¡_å¼€æ¨¡å››æ®µ_ä½ç½®'),
        'E20': get_val('å¼€æ¨¡_å¼€æ¨¡äº”æ®µ_å‹åŠ›'), 
        'G20': get_val('å¼€æ¨¡_å¼€æ¨¡äº”æ®µ_é€Ÿåº¦'),
        'I20': get_val('å¼€æ¨¡_å¼€æ¨¡äº”æ®µ_ä½ç½®'),
        'K16': get_val('å¼€æ¨¡_æ—¶é—´'),
        'E21': get_val('ä¸­å­_ä¸­å­Aè¿›_å‹åŠ›'), 
        'G21': get_val('ä¸­å­_ä¸­å­Aè¿›_é€Ÿåº¦'),
        'I21': get_val('ä¸­å­_ä¸­å­Aè¿›_ä½ç½®'),
        'K21': get_val('ä¸­å­_ä¸­å­Aè¿›_æ—¶é—´'),
        'E22': get_val('ä¸­å­_ä¸­å­Aé€€_å‹åŠ›'), 
        'G22': get_val('ä¸­å­_ä¸­å­Aé€€_é€Ÿåº¦'),
        'I22': get_val('ä¸­å­_ä¸­å­Aé€€_ä½ç½®'),
        'K22': get_val('ä¸­å­_ä¸­å­Aé€€_æ—¶é—´'),
        'E23': get_val('ä¸­å­_ä¸­å­Bè¿›_å‹åŠ›'), 
        'G23': get_val('ä¸­å­_ä¸­å­Bè¿›_é€Ÿåº¦'),
        'I23': get_val('ä¸­å­_ä¸­å­Bè¿›_ä½ç½®'),
        'K23': get_val('ä¸­å­_ä¸­å­Bè¿›_æ—¶é—´'),
        'E24': get_val('ä¸­å­_ä¸­å­Bé€€_å‹åŠ›'), 
        'G24': get_val('ä¸­å­_ä¸­å­Bé€€_é€Ÿåº¦'),
        'I24': get_val('ä¸­å­_ä¸­å­Bé€€_ä½ç½®'),
        'K24': get_val('ä¸­å­_ä¸­å­Bé€€_æ—¶é—´'),
        'E25': get_val('å°„èƒ¶_ä¸€æ®µ_å‹åŠ›'), 
        'G25': get_val('å°„èƒ¶_ä¸€æ®µ_é€Ÿåº¦'),
        'I25': get_val('å°„èƒ¶_ä¸€æ®µ_ä½ç½®'),
        'E26': get_val('å°„èƒ¶_äºŒæ®µ_å‹åŠ›'),
        'G26': get_val('å°„èƒ¶_äºŒæ®µ_é€Ÿåº¦'),
        'I26': get_val('å°„èƒ¶_äºŒæ®µ_ä½ç½®'),
        'E27': get_val('å°„èƒ¶_ä¸‰æ®µ_å‹åŠ›'),
        'G27': get_val('å°„èƒ¶_ä¸‰æ®µ_é€Ÿåº¦'),
        'I27': get_val('å°„èƒ¶_ä¸‰æ®µ_ä½ç½®'),
        'E28': get_val('å°„èƒ¶_å››æ®µ_å‹åŠ›'),
        'G28': get_val('å°„èƒ¶_å››æ®µ_é€Ÿåº¦'),
        'I28': get_val('å°„èƒ¶_å››æ®µ_ä½ç½®'),
        'E29': get_val('å°„èƒ¶_äº”æ®µ_å‹åŠ›'),
        'G29': get_val('å°„èƒ¶_äº”æ®µ_é€Ÿåº¦'),
        'I29': get_val('å°„èƒ¶_äº”æ®µ_ä½ç½®'),
        'K27': get_val('å°„èƒ¶_æ³¨å°„æ—¶é—´'),
        'E31': get_val('ä¿å‹_ä¿ä¸€_æ—¶é—´'),
        'G31': get_val('ä¿å‹_ä¿ä¸€_ä½ç½®'),
        'I31': get_val('ä¿å‹_ä¿ä¸€_ä¿å‹æ—¶é—´'),
        'E32': get_val('ä¿å‹_ä¿äºŒ_æ—¶é—´'),
        'G32': get_val('ä¿å‹_ä¿äºŒ_ä½ç½®'),
        'I32': get_val('ä¿å‹_ä¿äºŒ_ä¿å‹æ—¶é—´'),
        'E33': get_val('ä¿å‹_ä¿ä¸‰_æ—¶é—´'),
        'G33': get_val('ä¿å‹_ä¿ä¸‰_ä½ç½®'),
        'I33': get_val('ä¿å‹_ä¿ä¸‰_ä¿å‹æ—¶é—´'),
        'Q12': get_val('ç†”èƒ¶_ä¸€æ®µç†”èƒ¶_ç†”æ–™å‰'),
        'S12': get_val('ç†”èƒ¶_ä¸€æ®µç†”èƒ¶_ç†”æ–™å'),
        'U12': get_val('ç†”èƒ¶_ä¸€æ®µç†”èƒ¶_ç†”æ–™ä¸­'),
        'Q13': get_val('ç†”èƒ¶_äºŒæ®µç†”èƒ¶_ç†”æ–™å‰'),
        'S13': get_val('ç†”èƒ¶_äºŒæ®µç†”èƒ¶_ç†”æ–™å'),
        'U13': get_val('ç†”èƒ¶_äºŒæ®µç†”èƒ¶_ç†”æ–™ä¸­'),
        'Q14': get_val('ç†”èƒ¶_ä¸‰æ®µç†”èƒ¶_ç†”æ–™å‰'),
        'S14': get_val('ç†”èƒ¶_ä¸‰æ®µç†”èƒ¶_ç†”æ–™å'),
        'U14': get_val('ç†”èƒ¶_ä¸‰æ®µç†”èƒ¶_ç†”æ–™ä¸­'),
        'Q15': get_val('ç†”èƒ¶_å››æ®µç†”èƒ¶_ç†”æ–™å‰'),
        'S15': get_val('ç†”èƒ¶_å››æ®µç†”èƒ¶_ç†”æ–™å'),
        'U15': get_val('ç†”èƒ¶_å››æ®µç†”èƒ¶_ç†”æ–™ä¸­'),
        'Q16': get_val('ç†”èƒ¶_èºæ†æ¾é€€_ç†”æ–™å‰'),
        'S16': get_val('ç†”èƒ¶_èºæ†æ¾é€€_ç†”æ–™å'),
        'U16': get_val('ç†”èƒ¶_èºæ†æ¾é€€_ç†”æ–™ä¸­'),
        'W11': cool_str,
        'W14': bp_str,
        'Q17': get_val('é¡¶é’ˆ_é¡¶è¿›ä¸€'),
        'S17': get_val('é¡¶é’ˆ_é¡¶è¿›ä¸€_1'),
        'U17': get_val('é¡¶é’ˆ_é¡¶è¿›ä¸€_2'),
        'W17': get_val('é¡¶é’ˆ_é¡¶é’ˆå»¶è¿Ÿ'),
        'Q18': get_val('é¡¶é’ˆ_é¡¶è¿›äºŒ'),
        'S18': get_val('é¡¶é’ˆ_é¡¶è¿›äºŒ_1'),
        'U18': get_val('é¡¶é’ˆ_é¡¶è¿›äºŒ_2'),
        'W18': get_val('é¡¶é’ˆ_é¡¶é’ˆå»¶è¿Ÿ_1'),
        # 'P21': f"{get_val('å…¬æ¨¡ï¼š', 'é¡¶é’ˆ_å¹æ°”_å…¬æ¨¡/s', ' ç§’   æ¯æ¨¡ï¼š', 'é¡¶é’ˆ_å¹æ°”_æ¯æ¨¡/s', ' ç§’  ä½ç½®ï¼š ', 'é¡¶é’ˆ_å¹æ°”_ä½ç½®/mm', ' mm')}",
        # 'P23': f"{get_val('é¡¶é’ˆæ¬¡æ•°ï¼š', 'é¡¶é’ˆ_é¡¶å‡ºæ–¹å¼_é¡¶é’ˆæ¬¡æ•°') }",
        # èµ‹å€¼
        # 'P21': f"å…¬æ¨¡ï¼š{get_val('é¡¶é’ˆ_å¹æ°”_å…¬æ¨¡/s')} ç§’   æ¯æ¨¡ï¼š{get_val('é¡¶é’ˆ_å¹æ°”_æ¯æ¨¡/s')} ç§’   ä½ç½®ï¼š {get_val('é¡¶é’ˆ_å¹æ°”_ä½ç½®/mm')} mm",
        # 'P23': f"é¡¶é’ˆæ¬¡æ•°ï¼š{get_val('é¡¶é’ˆ_é¡¶å‡ºæ–¹å¼_é¡¶é’ˆæ¬¡æ•°')}",
        'P21': blow_text,
        'P23': eject_text,
        'O25': get_val('æ–™ç®¡æ¸©åº¦/â„ƒ_å°„å˜´'),
        'P25': get_val('æ–™ç®¡æ¸©åº¦/â„ƒ_ä¸€æ®µ'),
        'Q25': get_val('æ–™ç®¡æ¸©åº¦/â„ƒ_äºŒæ®µ'),
        'R25': get_val('æ–™ç®¡æ¸©åº¦/â„ƒ_ä¸‰æ®µ'),
        'S25': get_val('æ–™ç®¡æ¸©åº¦/â„ƒ_å››æ®µ'),
        'T25': get_val('æ–™ç®¡æ¸©åº¦/â„ƒ_äº”æ®µ'),
        'U25': get_val('æ–™ç®¡æ¸©åº¦/â„ƒ_å…­æ®µ'),
        'V25': get_val('æ–™ç®¡æ¸©åº¦/â„ƒ_ä¸ƒæ®µ'),
        'Q26': get_val('æ¸©æ§ç®±è®¾å®š/â„ƒ_ä¸€æ®µ'),
        'Q27': get_val('æ¸©æ§ç®±è®¾å®š/â„ƒ_äºŒæ®µ'),
        'Q28': get_val('æ¸©æ§ç®±è®¾å®š/â„ƒ_ä¸‰æ®µ'),
        'Q29': get_val('æ¸©æ§ç®±è®¾å®š/â„ƒ_å››æ®µ'),
        'Q30': get_val('æ¸©æ§ç®±è®¾å®š/â„ƒ_äº”æ®µ'),
        'V26': get_val('æ¸©æ§ç®±è®¾å®š/â„ƒ_å…­æ®µ'),
        'V27': get_val('æ¸©æ§ç®±è®¾å®š/â„ƒ_ä¸ƒæ®µ'),
        'V28': get_val('æ¸©æ§ç®±è®¾å®š/â„ƒ_å…«æ®µ'),
        'V29': get_val('æ¸©æ§ç®±è®¾å®š/â„ƒ_ä¹æ®µ'),
        'V30': get_val('æ¸©æ§ç®±è®¾å®š/â„ƒ_åæ®µ'),
        'G35': get_val('æ¨¡æ¸©_å‰æ¨¡'),
        'K35': get_val('æ¨¡æ¸©_åæ¨¡'),
        'G36': get_val('æ°´æ¸©_å‰æ¨¡'),
        'K36': get_val('æ°´æ¸©_åæ¨¡'),
        'G37': get_val('å†·å´æ°´ç»„æ•°_å‰æ¨¡'),
        'K37': get_val('å†·å´æ°´ç»„æ•°_åæ¨¡'),
        'G38': get_val('æœºæ¢°æ²¹æ¸©_ä½é™30â„ƒ'),
        'K38': get_val('æœºæ¢°æ²¹æ¸©_é«˜é™60â„ƒ'),
        # ... è¯·ç»§ç»­è¡¥å……å…¶ä»–å‚æ•° ...
    }

    # --- 3. å†™å…¥æ•°æ® ---
    for cell, value in mapping.items():
        if value: # åªè¦ä¸æ˜¯ç©ºå­—ç¬¦ä¸²
            ws[cell] = value

    # --- 4. ä¿å­˜æ–‡ä»¶ ---
    # æ–‡ä»¶åæ ¼å¼: _010_ + æ¨¡å…·ç¼–å· + ä½œä¸šæŒ‡å¯¼ä¹¦1.0_SOP
    file_name = f"_010_{mold_id}ä½œä¸šæŒ‡å¯¼ä¹¦1.0_SOP.xlsx"
    # å¤„ç†éæ³•å­—ç¬¦ (é˜²æ­¢æ–‡ä»¶åæŠ¥é”™)
    file_name = file_name.replace('/', '_').replace('\\', '_')

    save_path = os.path.join(output_folder, file_name)
    wb.save(save_path)
    print(f"âœ… ç”ŸæˆæˆåŠŸ: {file_name}")

# ================= æ‰§è¡Œå¾ªç¯ =================
print("ğŸš€ å¼€å§‹æ‰§è¡Œ...")
count = 0
for i, row in df.iterrows():
    try:
        generate_sop(row)
        count += 1
    except Exception as e:
        print(f"âŒ ç¬¬ {i+1} è¡Œå‡ºé”™: {e}")

print(f"\nğŸ‰ å¤„ç†å®Œæ¯•ï¼å…±ç”Ÿæˆ {count} ä»½ä½œä¸šæŒ‡å¯¼ä¹¦ã€‚")